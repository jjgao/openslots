<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <style>
    body {
      font-family: 'Google Sans', Arial, sans-serif;
      padding: 16px;
      margin: 0;
      font-size: 14px;
    }
    .form-section {
      margin-bottom: 20px;
      padding-bottom: 20px;
      border-bottom: 1px solid #e0e0e0;
    }
    .form-section:last-child {
      border-bottom: none;
    }
    .section-title {
      font-size: 16px;
      font-weight: 500;
      margin-bottom: 12px;
      color: #1a73e8;
    }
    .form-group {
      margin-bottom: 12px;
    }
    label {
      display: block;
      margin-bottom: 4px;
      font-weight: 500;
      color: #5f6368;
      font-size: 13px;
    }
    input[type="text"],
    input[type="email"],
    input[type="date"],
    select,
    textarea {
      width: 100%;
      padding: 8px;
      border: 1px solid #dadce0;
      border-radius: 4px;
      box-sizing: border-box;
      font-size: 14px;
    }
    textarea {
      resize: vertical;
      min-height: 60px;
    }
    button {
      background-color: #1a73e8;
      color: white;
      border: none;
      padding: 10px 24px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 500;
      width: 100%;
      margin-top: 8px;
    }
    button:hover {
      background-color: #1765cc;
    }
    button:disabled {
      background-color: #dadce0;
      cursor: not-allowed;
    }
    .secondary-btn {
      background-color: white;
      color: #1a73e8;
      border: 1px solid #dadce0;
    }
    .secondary-btn:hover {
      background-color: #f8f9fa;
    }
    .error {
      color: #d93025;
      font-size: 12px;
      margin-top: 4px;
    }
    .success {
      color: #188038;
      font-size: 12px;
      margin-top: 4px;
    }
    .client-result {
      padding: 8px;
      border: 1px solid #dadce0;
      border-radius: 4px;
      margin-bottom: 8px;
      cursor: pointer;
      background-color: white;
    }
    .client-result:hover {
      background-color: #f8f9fa;
    }
    .client-result.selected {
      background-color: #e8f0fe;
      border-color: #1a73e8;
    }
    .client-name {
      font-weight: 500;
      margin-bottom: 2px;
    }
    .client-info {
      font-size: 12px;
      color: #5f6368;
    }
    .hidden {
      display: none;
    }
    .time-slot {
      display: inline-block;
      padding: 6px 12px;
      margin: 4px;
      border: 1px solid #dadce0;
      border-radius: 4px;
      cursor: pointer;
      font-size: 13px;
      background-color: white;
    }
    .time-slot:hover {
      background-color: #f8f9fa;
    }
    .time-slot.selected {
      background-color: #1a73e8;
      color: white;
      border-color: #1a73e8;
    }
    .time-slots-container {
      max-height: 200px;
      overflow-y: auto;
      padding: 8px;
      border: 1px solid #dadce0;
      border-radius: 4px;
      background-color: #f8f9fa;
    }
    .loading {
      text-align: center;
      color: #5f6368;
      padding: 12px;
    }
    .info-box {
      background-color: #e8f0fe;
      border-left: 4px solid #1a73e8;
      padding: 12px;
      margin-bottom: 16px;
      font-size: 13px;
    }
  </style>
</head>
<body>
  <div id="app">
    <!-- Step 1: Client Selection -->
    <div class="form-section" id="clientSection">
      <div class="section-title">1. Select or Create Client</div>

      <div class="form-group">
        <label for="clientSearch">Search by name or phone</label>
        <input type="text" id="clientSearch" placeholder="Enter name or phone number" onkeypress="handleSearchKeyPress(event)">
      </div>

      <button class="secondary-btn" onclick="searchClient()">Search</button>

      <div id="clientResults" class="hidden" style="margin-top: 12px;">
        <!-- Client search results will appear here -->
      </div>

      <button class="secondary-btn" onclick="showNewClientForm()">+ Create New Client</button>

      <!-- New Client Form -->
      <div id="newClientForm" class="hidden" style="margin-top: 16px;">
        <div class="form-group">
          <label for="newClientName">Name *</label>
          <input type="text" id="newClientName" placeholder="John Doe">
        </div>
        <div class="form-group">
          <label for="newClientPhone">Phone *</label>
          <input type="text" id="newClientPhone" placeholder="(555) 123-4567">
        </div>
        <div class="form-group">
          <label for="newClientEmail">Email</label>
          <input type="email" id="newClientEmail" placeholder="john@example.com">
        </div>
        <div class="form-group">
          <label for="newClientNotes">Notes</label>
          <textarea id="newClientNotes" placeholder="Any special notes..."></textarea>
        </div>
        <button onclick="createNewClient()">Create Client</button>
        <button class="secondary-btn" onclick="hideNewClientForm()">Cancel</button>
        <div id="newClientError" class="error hidden"></div>
        <div id="newClientSuccess" class="success hidden"></div>
      </div>

      <div id="selectedClientInfo" class="info-box hidden">
        <strong id="selectedClientName"></strong><br>
        <span id="selectedClientPhone"></span><br>
        <span id="selectedClientEmail"></span>
      </div>
    </div>

    <!-- Step 2: Appointment Details -->
    <div class="form-section" id="appointmentSection">
      <div class="section-title">2. Appointment Details</div>

      <div class="form-group">
        <label for="service">Service *</label>
        <select id="service" onchange="onServiceChange()">
          <option value="">Select service...</option>
        </select>
      </div>

      <div class="form-group" id="durationGroup" class="hidden">
        <label for="duration">Duration *</label>
        <select id="duration" onchange="onDurationChange()">
          <option value="">Select duration...</option>
        </select>
      </div>

      <div class="form-group">
        <label for="appointmentDate">Date *</label>
        <input type="date" id="appointmentDate" onchange="onDateChange()">
      </div>

      <div class="form-group">
        <label for="provider">Provider *</label>
        <select id="provider" onchange="onProviderChange()">
          <option value="">Select provider...</option>
        </select>
      </div>

      <div class="form-group" id="timeSlotsGroup" class="hidden">
        <label>Available Time Slots</label>
        <div id="timeSlots" class="time-slots-container">
          <!-- Time slots will appear here -->
        </div>
      </div>

      <div class="form-group">
        <label for="notes">Notes</label>
        <textarea id="notes" placeholder="Any special requests or notes..."></textarea>
      </div>
    </div>

    <!-- Step 3: Book -->
    <div class="form-section">
      <button id="bookButton" onclick="bookAppointment()" disabled>Book Appointment</button>
      <div id="bookingError" class="error hidden"></div>
      <div id="bookingSuccess" class="success hidden"></div>
    </div>
  </div>

  <script>
    var selectedClientId = null;
    var selectedTimeSlot = null;
    var formData = null;

    // Load form data on page load
    google.script.run
      .withSuccessHandler(function(data) {
        formData = data;
        populateProviders(data.providers);
        populateServices(data.services);
      })
      .withFailureHandler(function(error) {
        showError('bookingError', 'Error loading form data: ' + error.message);
      })
      .getBookingFormData();

    function populateProviders(providers) {
      var select = document.getElementById('provider');
      providers.forEach(function(p) {
        var option = document.createElement('option');
        option.value = p.provider_id;
        option.dataset.providerName = p.name; // Store original name
        option.dataset.slotCount = '-1'; // Initialize (no availability data yet)
        option.dataset.isReturning = 'false'; // Initialize (no returning indicator)
        option.textContent = p.name; // Start with just name
        select.appendChild(option);
      });
    }

    function populateServices(services) {
      var select = document.getElementById('service');
      services.forEach(function(s) {
        var option = document.createElement('option');
        option.value = s.service_id;
        option.textContent = s.name;
        select.appendChild(option);
      });

      // Set minimum date to today (disable past dates)
      var today = new Date().toISOString().split('T')[0];
      document.getElementById('appointmentDate').min = today;
    }

    function handleSearchKeyPress(event) {
      if (event.key === 'Enter' || event.keyCode === 13) {
        event.preventDefault();
        searchClient();
      }
    }

    function searchClient() {
      var searchTerm = document.getElementById('clientSearch').value;
      if (!searchTerm.trim()) {
        showError('bookingError', 'Please enter a search term');
        return;
      }

      hideError('bookingError');
      document.getElementById('clientResults').innerHTML = '<div class="loading">Searching...</div>';
      document.getElementById('clientResults').classList.remove('hidden');

      google.script.run
        .withSuccessHandler(function(clients) {
          displayClientResults(clients);
        })
        .withFailureHandler(function(error) {
          showError('bookingError', 'Search error: ' + error.message);
        })
        .searchClientsForUI(searchTerm);
    }

    function displayClientResults(clients) {
      var resultsDiv = document.getElementById('clientResults');

      if (clients.length === 0) {
        resultsDiv.innerHTML = '<div class="client-info">No clients found. Create a new client below.</div>';
        return;
      }

      var html = '';
      clients.forEach(function(client) {
        html += '<div class="client-result" onclick="selectClient(\'' + client.client_id + '\')">';
        html += '<div class="client-name">' + client.name + '</div>';
        html += '<div class="client-info">' + client.phone;
        if (client.email) html += ' • ' + client.email;
        html += '</div></div>';
      });

      resultsDiv.innerHTML = html;
    }

    function selectClient(clientId) {
      selectedClientId = clientId;

      // Highlight selected client
      var results = document.querySelectorAll('.client-result');
      results.forEach(function(r) {
        r.classList.remove('selected');
      });
      event.target.closest('.client-result').classList.add('selected');

      // Get client details
      google.script.run
        .withSuccessHandler(function(data) {
          if (data && data.client) {
            displaySelectedClient(data.client, data.stats);
          }
        })
        .getClientDetails(clientId);

      checkCanBook();
    }

    function displaySelectedClient(client, stats) {
      var infoBox = document.getElementById('selectedClientInfo');
      document.getElementById('selectedClientName').textContent = client.name;
      document.getElementById('selectedClientPhone').textContent = client.phone;
      document.getElementById('selectedClientEmail').textContent = client.email || '';
      infoBox.classList.remove('hidden');
    }

    function showNewClientForm() {
      document.getElementById('newClientForm').classList.remove('hidden');
    }

    function hideNewClientForm() {
      document.getElementById('newClientForm').classList.add('hidden');
      document.getElementById('newClientName').value = '';
      document.getElementById('newClientPhone').value = '';
      document.getElementById('newClientEmail').value = '';
      document.getElementById('newClientNotes').value = '';
      hideError('newClientError');
      hideSuccess('newClientSuccess');
    }

    function createNewClient() {
      var clientData = {
        name: document.getElementById('newClientName').value,
        phone: document.getElementById('newClientPhone').value,
        email: document.getElementById('newClientEmail').value,
        notes: document.getElementById('newClientNotes').value
      };

      hideError('newClientError');
      hideSuccess('newClientSuccess');

      google.script.run
        .withSuccessHandler(function(result) {
          if (result.success) {
            showSuccess('newClientSuccess', result.message);
            selectedClientId = result.client_id;

            // Show selected client
            var client = {
              name: clientData.name,
              phone: clientData.phone,
              email: clientData.email
            };
            displaySelectedClient(client, {});

            // Hide form after brief delay
            setTimeout(function() {
              hideNewClientForm();
            }, 1500);

            checkCanBook();
          } else {
            showError('newClientError', result.error);
          }
        })
        .withFailureHandler(function(error) {
          showError('newClientError', 'Error creating client: ' + error.message);
        })
        .createClientFromUI(clientData);
    }

    function onServiceChange() {
      var serviceId = document.getElementById('service').value;
      var durationSelect = document.getElementById('duration');
      var durationGroup = document.getElementById('durationGroup');

      // Clear duration dropdown
      durationSelect.innerHTML = '<option value="">Select duration...</option>';

      if (!serviceId) {
        durationGroup.classList.add('hidden');
        checkAvailability();
        return;
      }

      // Get service and populate duration options
      var service = formData.services.find(function(s) {
        return s.service_id === serviceId;
      });

      if (service) {
        // Ensure duration_options is a string, handle both string and number types
        var durationStr = String(service.default_duration_options);
        // Split by pipe (|) to avoid issues with comma being interpreted as number formatting
        var durationOptions = durationStr.split('|').map(function(d) { return d.trim(); });

        durationOptions.forEach(function(duration) {
          var option = document.createElement('option');
          option.value = duration;
          option.textContent = duration + ' minutes';
          durationSelect.appendChild(option);
        });

        // Always auto-select the first option
        if (durationOptions.length > 0) {
          durationSelect.value = durationOptions[0];
        }

        durationGroup.classList.remove('hidden');
      }

      updateProviderAvailability(); // Update provider availability when service changes
      checkAvailability();
    }

    function checkAvailability() {
      var providerId = document.getElementById('provider').value;
      var serviceId = document.getElementById('service').value;
      var duration = document.getElementById('duration').value;
      var date = document.getElementById('appointmentDate').value;

      if (!providerId || !serviceId || !duration || !date) {
        document.getElementById('timeSlotsGroup').classList.add('hidden');
        checkCanBook();
        return;
      }

      // Show loading
      document.getElementById('timeSlots').innerHTML = '<div class="loading">Loading available times...</div>';
      document.getElementById('timeSlotsGroup').classList.remove('hidden');

      google.script.run
        .withSuccessHandler(function(result) {
          console.log('Time slots result:', result);
          if (result.success) {
            console.log('Slots:', result.slots);
            displayTimeSlots(result.slots);
          } else {
            console.error('Error getting slots:', result.error);
            document.getElementById('timeSlots').innerHTML = '<div class="error">' + result.error + '</div>';
          }
          checkCanBook();
        })
        .withFailureHandler(function(error) {
          console.error('Failed to get time slots:', error);
          document.getElementById('timeSlots').innerHTML = '<div class="error">Error: ' + error.message + '</div>';
          checkCanBook();
        })
        .getAvailableTimeSlots(providerId, date, parseInt(duration));
    }

    function displayTimeSlots(slots) {
      var slotsDiv = document.getElementById('timeSlots');

      if (slots.length === 0) {
        slotsDiv.innerHTML = '<div class="client-info">No available time slots</div>';
        return;
      }

      var html = '';
      slots.forEach(function(slot) {
        html += '<span class="time-slot" onclick="selectTimeSlot(\'' + slot + '\')">' + slot + '</span>';
      });

      slotsDiv.innerHTML = html;
    }

    function selectTimeSlot(time) {
      selectedTimeSlot = time;

      // Highlight selected slot
      var slots = document.querySelectorAll('.time-slot');
      slots.forEach(function(s) {
        s.classList.remove('selected');
      });
      event.target.classList.add('selected');

      checkCanBook();
    }

    function checkCanBook() {
      var canBook = selectedClientId &&
                    document.getElementById('provider').value &&
                    document.getElementById('service').value &&
                    document.getElementById('duration').value &&
                    document.getElementById('appointmentDate').value &&
                    selectedTimeSlot;

      document.getElementById('bookButton').disabled = !canBook;
    }

    function bookAppointment() {
      hideError('bookingError');
      hideSuccess('bookingSuccess');

      var bookingData = {
        clientId: selectedClientId,
        providerId: document.getElementById('provider').value,
        serviceId: document.getElementById('service').value,
        duration: parseInt(document.getElementById('duration').value),
        date: document.getElementById('appointmentDate').value,
        startTime: selectedTimeSlot,
        notes: document.getElementById('notes').value
      };

      document.getElementById('bookButton').disabled = true;
      document.getElementById('bookButton').textContent = 'Booking...';

      google.script.run
        .withSuccessHandler(function(result) {
          document.getElementById('bookButton').textContent = 'Book Appointment';

          if (result.success) {
            showSuccess('bookingSuccess', 'Appointment booked successfully! ID: ' + result.appointmentId);

            // Reset form after brief delay
            setTimeout(function() {
              resetForm();
            }, 2000);
          } else {
            showError('bookingError', result.error);
            document.getElementById('bookButton').disabled = false;
          }
        })
        .withFailureHandler(function(error) {
          document.getElementById('bookButton').textContent = 'Book Appointment';
          showError('bookingError', 'Booking error: ' + error.message);
          document.getElementById('bookButton').disabled = false;
        })
        .bookAppointmentFromUI(bookingData);
    }

    function resetForm() {
      selectedClientId = null;
      selectedTimeSlot = null;

      document.getElementById('clientSearch').value = '';
      document.getElementById('clientResults').innerHTML = '';
      document.getElementById('clientResults').classList.add('hidden');
      document.getElementById('selectedClientInfo').classList.add('hidden');
      document.getElementById('provider').value = '';
      document.getElementById('service').value = '';
      document.getElementById('appointmentDate').value = '';
      document.getElementById('notes').value = '';
      document.getElementById('timeSlotsGroup').classList.add('hidden');

      hideError('bookingError');
      hideSuccess('bookingSuccess');

      checkCanBook();
    }

    function showError(elementId, message) {
      var el = document.getElementById(elementId);
      el.textContent = message;
      el.classList.remove('hidden');
    }

    function hideError(elementId) {
      document.getElementById(elementId).classList.add('hidden');
    }

    function showSuccess(elementId, message) {
      var el = document.getElementById(elementId);
      el.textContent = message;
      el.classList.remove('hidden');
    }

    function hideSuccess(elementId) {
      document.getElementById(elementId).classList.add('hidden');
    }

    // ========== Provider Availability Indicators ==========

    /**
     * Formats provider option text with availability and returning indicator
     * @param {string} providerName - The provider's name
     * @param {number} slotCount - Number of available slots (-1 = no data, 0 = unavailable, >0 = available)
     * @param {boolean} isReturningProvider - True if this provider has served this client before
     * @returns {string} Formatted text for dropdown option
     */
    function formatProviderOption(providerName, slotCount, isReturningProvider) {
      var text = providerName;

      // Add availability info if we have it
      if (slotCount === 0) {
        text += ' (No slots available)';
      } else if (slotCount > 0) {
        text += ' (' + slotCount + ' slot' + (slotCount === 1 ? '' : 's') + ' available)';
      }
      // If slotCount === -1, no availability info (show name only)

      // Add returning indicator
      if (isReturningProvider) {
        text += ' ★ Returning';
      }

      return text;
    }

    /**
     * Updates provider dropdown with availability indicators
     * Triggered when service, duration, or date changes
     */
    function updateProviderAvailability() {
      console.log('updateProviderAvailability() called');

      var clientId = selectedClientId || null;
      var serviceId = document.getElementById('service').value;
      var duration = document.getElementById('duration').value;
      var date = document.getElementById('appointmentDate').value;

      console.log('Values:', { clientId: clientId, serviceId: serviceId, duration: duration, date: date });

      // Need date and duration to calculate availability
      if (!date || !duration) {
        console.log('Missing date or duration, resetting dropdown');
        resetProviderDropdown();
        return;
      }

      var providerSelect = document.getElementById('provider');
      var currentSelection = providerSelect.value;

      console.log('Calling backend getAllProvidersAvailability...');

      // Call backend to get availability for all providers
      google.script.run
        .withSuccessHandler(function(result) {
          console.log('Backend response:', result);
          if (result.success) {
            updateProviderDropdownOptions(result.providers, currentSelection);
          } else {
            console.error('Error getting provider availability:', result.error);
          }
        })
        .withFailureHandler(function(error) {
          console.error('Failed to get provider availability:', error);
        })
        .getAllProvidersAvailability(serviceId, date, parseInt(duration), clientId);
    }

    /**
     * Updates provider dropdown options with availability counts and returning indicators
     * @param {Array} providers - Array of provider data from backend
     * @param {string} currentSelection - The currently selected provider ID
     */
    function updateProviderDropdownOptions(providers, currentSelection) {
      console.log('updateProviderDropdownOptions() called with', providers.length, 'providers');

      var select = document.getElementById('provider');

      // Update each option (skip index 0 which is the placeholder "Select provider...")
      for (var i = 1; i < select.options.length; i++) {
        var option = select.options[i];
        var providerId = option.value;

        // Find matching provider data
        var providerData = providers.find(function(p) {
          return p.provider_id === providerId;
        });

        if (providerData) {
          console.log('Updating provider:', providerData.name, 'slots:', providerData.slot_count, 'returning:', providerData.is_returning_provider);

          option.dataset.slotCount = providerData.slot_count.toString();
          option.dataset.isReturning = providerData.is_returning_provider.toString();

          var providerName = option.dataset.providerName;
          var formattedText = formatProviderOption(
            providerName,
            providerData.slot_count,
            providerData.is_returning_provider
          );

          console.log('Formatted text:', formattedText);
          option.textContent = formattedText;
        }
      }

      // Restore previous selection if it exists
      if (currentSelection) {
        select.value = currentSelection;
      }

      console.log('Provider dropdown updated successfully');
    }

    /**
     * Resets provider dropdown to show names without availability
     */
    function resetProviderDropdown() {
      var select = document.getElementById('provider');
      var currentSelection = select.value;

      // Reset each option to show name only
      for (var i = 1; i < select.options.length; i++) {
        var option = select.options[i];
        var providerName = option.dataset.providerName;

        if (providerName) {
          option.dataset.slotCount = '-1';
          option.dataset.isReturning = 'false';
          option.textContent = providerName;
        }
      }

      // Restore selection
      if (currentSelection) {
        select.value = currentSelection;
      }
    }

    /**
     * Handler for provider selection change
     */
    function onProviderChange() {
      var providerSelect = document.getElementById('provider');
      var selectedOption = providerSelect.options[providerSelect.selectedIndex];

      // Check if provider has 0 slots (already checked by getAllProvidersAvailability)
      if (selectedOption && selectedOption.dataset.slotCount === '0') {
        // Provider has no slots - show message without calling backend
        document.getElementById('timeSlots').innerHTML = '<div class="client-info">No available time slots for this provider</div>';
        document.getElementById('timeSlotsGroup').classList.remove('hidden');
        selectedTimeSlot = null;
        checkCanBook();
        return;
      }

      // Provider has slots (or unknown) - fetch time slots from backend
      checkAvailability();
    }

    /**
     * Handler for duration change
     */
    function onDurationChange() {
      updateProviderAvailability(); // Update provider availability
      checkAvailability(); // Fetch time slots
    }

    /**
     * Handler for date change
     */
    function onDateChange() {
      updateProviderAvailability(); // Update provider availability
      checkAvailability(); // Fetch time slots
    }
  </script>
</body>
</html>
